generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  role         UserRole     @default(client)
  category     String       @default("Worker")
  status       UserStatus   @default(active)
  firstName    String?      @map("first_name")
  lastName     String?      @map("last_name")
  organization String?
  violations   Int          @default(0)
  riskScore    Int          @default(0) @map("risk_score")
  inactiveDays Int          @default(0) @map("inactive_days")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  lastLoginAt  DateTime?    @map("last_login_at")
  loginAudits  LoginAudit[]
  cases        Case[]

  @@map("users")
}

enum UserRole {
  client
  attorney
  employer
  admin
}

enum UserStatus {
  active
  inactive
  blocked
  removed
}

model LoginAudit {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  email     String
  success   Boolean
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([email])
  @@index([timestamp])
  @@map("login_audit")
}

model SecurityAlert {
  id          String   @id @default(cuid())
  type        String
  severity    String
  email       String?
  ipAddress   String?  @map("ip_address")
  description String?
  status      String   @default("open")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([type])
  @@index([status])
  @@map("security_alerts")
}

model Case {
  id             String          @id @default(cuid())
  caseNumber     String          @unique @map("case_number")
  userId         String          @map("user_id")
  status         String          @default("open")
  stage          String?
  description    String?
  totalDelayDays Int             @default(0) @map("total_delay_days")
  breachCount    Int             @default(0) @map("breach_count")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  user           User            @relation(fields: [userId], references: [id])
  timeline       TimelineEvent[]

  @@index([caseNumber])
  @@index([userId])
  @@map("cases")
}

model TimelineEvent {
  id          String   @id @default(cuid())
  caseId      String   @map("case_id")
  type        String
  title       String
  description String?
  actor       String?
  timestamp   DateTime @default(now())
  case        Case     @relation(fields: [caseId], references: [id])

  @@index([caseId])
  @@map("timeline_events")
}

// ============================================================================
// HBS AUTOPILOT v8 MODELS
// ============================================================================

model FeatureFlag {
  id              String   @id @default(cuid())
  key             String   @unique
  enabled         Boolean  @default(false)
  rolloutStrategy Json?    @map("rollout_strategy")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String?  @map("created_by")

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}

model AutopilotDecision {
  id                    String   @id @default(cuid())
  requestId             String   @unique @map("request_id")
  version               String
  actionType            String   @map("action_type")
  recommendedAction     String   @map("recommended_action")
  riskLevel             String   @map("risk_level")
  riskScore             Float    @map("risk_score")
  confidence            Float
  reasoning             String?  @db.Text
  reasoningTrace        Json?    @map("reasoning_trace")
  safetyCheck           Json?    @map("safety_check")
  humanApprovalRequired Boolean  @default(false) @map("human_approval_required")
  countryCode           String   @map("country_code")
  userId                String   @map("user_id")
  processingTimeMs      Int      @map("processing_time_ms")
  metadata              Json?
  createdAt             DateTime @default(now()) @map("created_at")

  @@index([version])
  @@index([countryCode])
  @@index([actionType])
  @@index([createdAt])
  @@map("autopilot_decisions")
}

model AutopilotComparison {
  id              String   @id @default(cuid())
  requestId       String   @map("request_id")
  v7DecisionId    String   @map("v7_decision_id")
  v8DecisionId    String   @map("v8_decision_id")
  actionChanged   Boolean  @map("action_changed")
  riskScoreDelta  Float    @map("risk_score_delta")
  confidenceDelta Float    @map("confidence_delta")
  similarity      Float
  recommendation  String
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([similarity])
  @@index([createdAt])
  @@map("autopilot_comparisons")
}

model CircuitBreakerState {
  id              String    @id @default(cuid())
  state           String
  failureCount    Int       @default(0) @map("failure_count")
  successCount    Int       @default(0) @map("success_count")
  lastFailureAt   DateTime? @map("last_failure_at")
  lastStateChange DateTime  @default(now()) @map("last_state_change")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("circuit_breaker_state")
}

// ============================================================================
// INFRASTRUCTURE & LOGISTICS HUB MODELS
// Added: $(date)
// ============================================================================

model Asset {
  id          String      @id @default(uuid())
  type        AssetType
  name        String
  description String?
  status      AssetStatus

  location Json

  ownerId    String
  operatorId String?

  specifications Json
  capacity       Json?

  constructionCost Json?
  estimatedValue   Json?

  parentAssetId String?
  parentAsset   Asset?  @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets   Asset[] @relation("AssetHierarchy")

  tags     String[]
  metadata Json

  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime  @updatedAt
  updatedBy String
  deletedAt DateTime?
  deletedBy String?

  projects             ProjectAsset[]
  cargosDestination    Cargo[]        @relation("CargoDestination")
  shipmentsDestination Shipment[]     @relation("ShipmentDestination")

  @@index([type])
  @@index([status])
  @@index([ownerId])
  @@map("assets")
}

enum AssetType {
  ROAD
  BRIDGE
  TUNNEL
  RAILWAY
  AIRPORT
  PORT
  POWER_PLANT
  SUBSTATION
  WATER_TREATMENT
  HOSPITAL
  SCHOOL
  WAREHOUSE
  OTHER
}

enum AssetStatus {
  OPERATIONAL
  UNDER_CONSTRUCTION
  DAMAGED
  UNDER_REPAIR
  DECOMMISSIONED
}

model Project {
  id          String       @id @default(uuid())
  name        String
  description String
  phase       ProjectPhase

  startDate      DateTime
  plannedEndDate DateTime
  actualEndDate  DateTime?

  budget    Json
  spent     Json
  committed Json

  donorIds      String[]
  implementerId String
  contractorIds String[]

  progressPercentage Float

  tags     String[]
  metadata Json

  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime  @updatedAt
  updatedBy String
  deletedAt DateTime?

  assets    ProjectAsset[]
  cargos    Cargo[]
  shipments Shipment[]

  @@index([phase])
  @@map("projects")
}

model ProjectAsset {
  projectId String
  assetId   String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([projectId, assetId])
  @@map("project_assets")
}

enum ProjectPhase {
  PLANNING
  DESIGN
  PROCUREMENT
  CONSTRUCTION
  INSPECTION
  HANDOVER
  COMPLETED
  ON_HOLD
  CANCELLED
}

model Cargo {
  id          String    @id @default(uuid())
  type        CargoType
  description String

  quantity      Json
  declaredValue Json

  hsCode                String?
  dangerous             Boolean @default(false)
  temperatureControlled Boolean @default(false)

  consignorId String
  consigneeId String

  projectId String?
  assetId   String?

  metadata Json

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String

  project   Project?        @relation(fields: [projectId], references: [id])
  asset     Asset?          @relation("CargoDestination", fields: [assetId], references: [id])
  shipments ShipmentCargo[]

  @@index([type])
  @@index([projectId])
  @@map("cargos")
}

enum CargoType {
  CONSTRUCTION_MATERIALS
  EQUIPMENT
  MEDICAL_SUPPLIES
  FOOD
  HUMANITARIAN_AID
  MACHINERY
  OTHER
}

model Shipment {
  id     String         @id @default(uuid())
  status ShipmentStatus

  routeId      String
  currentLegId String?

  plannedDeparture DateTime
  actualDeparture  DateTime?
  estimatedArrival DateTime
  actualArrival    DateTime?

  currentLocation Json?
  lastUpdate      DateTime @default(now())

  carrierId String
  vehicleId String?

  events   Json
  metadata Json

  projectId String?
  assetId   String?

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String

  route   Route           @relation(fields: [routeId], references: [id])
  project Project?        @relation(fields: [projectId], references: [id])
  asset   Asset?          @relation("ShipmentDestination", fields: [assetId], references: [id])
  cargos  ShipmentCargo[]

  @@index([status])
  @@index([routeId])
  @@map("shipments")
}

model ShipmentCargo {
  shipmentId String
  cargoId    String

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  cargo    Cargo    @relation(fields: [cargoId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([shipmentId, cargoId])
  @@map("shipment_cargos")
}

enum ShipmentStatus {
  PLANNED
  IN_TRANSIT
  CUSTOMS_CLEARANCE
  DELIVERED
  DELAYED
  CANCELLED
}

model Route {
  id   String        @id @default(uuid())
  name String
  mode TransportMode

  origin      Json
  destination Json

  legs              Json
  totalDistance     Json
  estimatedDuration Float

  preferredCarriers String[]
  restrictions      String[]
  metadata          Json

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String

  shipments Shipment[]

  @@index([mode])
  @@map("routes")
}

enum TransportMode {
  ROAD
  RAIL
  SEA
  AIR
  MULTIMODAL
}

model RiskScore {
  id String @id @default(uuid())

  entityType RiskEntityType
  entityId   String
  score      Float
  severity   RiskSeverity
  status     RiskStatus
  factors    Json
  assignedTo String?
  notes      String?

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String

  @@index([entityType, entityId])
  @@index([severity])
  @@map("risk_scores")
}

enum RiskEntityType {
  ASSET
  PROJECT
  CARGO
  SHIPMENT
  ROUTE
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  DETECTED
  INVESTIGATING
  MITIGATED
  RESOLVED
  FALSE_POSITIVE
}
